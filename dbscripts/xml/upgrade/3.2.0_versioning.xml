<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data SYSTEM "../../../lib/pkp/dtd/xmlData.dtd">

<!--
	* dbscripts/xml/upgrade/3.2.0_versioning.xml
	*
	* Copyright (c) 2013-2019 Simon Fraser University
	* Copyright (c) 2003-2019 John Willinsky
	* Distributed under the GNU GPL v2. For full terms see the file docs/COPYING.
	*
	* Copy submission data to temporary tables so it can be updated
	* after the publication table modifications are made.
	*
	-->

<data>
	<sql>
		<!-- change date_published from datetime to date before migrating -->
		<query>
			ALTER TABLE temp_published_submissions MODIFY COLUMN date_published date NULL
		</query>
		<!-- migrate data to new publications table -->
		<query>
			INSERT INTO publications (access_status, date_published, last_modified, locale, section_id, submission_id, status)
				SELECT COALESCE(ps.access_status, 0), COALESCE(ps.date_published, NULL), s.last_modified, s.locale, s.section_id, s.submission_id, s.status
				FROM temp_submissions as s
				LEFT JOIN temp_published_submissions as ps
					ON (s.submission_id = ps.submission_id)
				GROUP BY s.submission_id, ps.access_status, ps.date_published, s.last_modified, s.section_id, s.locale, s.status;
		</query>
		<query>
			UPDATE publications as p
			SET primary_contact_id = (
				SELECT a.author_id
				FROM temp_authors as a
				WHERE a.submission_id = p.submission_id
					AND a.primary_contact = 1
				LIMIT 1
			)
		</query>

		<!-- set the current_publication_id column in submissions -->
		<query>
			UPDATE submissions as s
			SET current_publication_id = (
				SELECT p.publication_id
				FROM publications as p
				WHERE s.submission_id = p.submission_id
			)
		</query>

		<!-- migrate submission_settings to publication_settings -->
		<query>
			INSERT INTO publication_settings(publication_id, locale, setting_name, setting_value)
				SELECT s.current_publication_id, ss.locale, ss.setting_name, ss.setting_value
				FROM submissions as s
				LEFT JOIN submission_settings as ss
					ON (ss.submission_id = s.submission_id)
				WHERE (
					setting_name IN ('abstract', 'cleanTitle', 'copyrightHolder', 'copyrightYear', 'coverage', 'coverImage', 'licenseUrl', 'locale', 'prefix', 'rights', 'source', 'subtitle', 'title', 'type')
					OR setting_name LIKE '%pub-id%'
				)
		</query>
		<query>
			DELETE FROM submission_settings
			WHERE (
				setting_name IN ('abstract', 'cleanTitle', 'copyrightHolder', 'copyrightYear', 'coverage', 'coverImage', 'coverImageAltText', 'licenseUrl', 'locale', 'prefix', 'rights', 'source', 'subtitle', 'title', 'type')
				OR setting_name LIKE '%pub-id%'
			)
		</query>

		<!-- migrate some data from submissions to publication_settings -->
		<query>
			INSERT INTO publication_settings(publication_id, setting_name, setting_value)
				SELECT s.current_publication_id, 'language', ts.language
				FROM submissions as s
				LEFT JOIN temp_submissions as ts
					ON s.submission_id = ts.submission_id
				WHERE ts.language != ''
		</query>
		<query>
			INSERT INTO publication_settings(publication_id, setting_name, setting_value)
				SELECT s.current_publication_id, 'citationsRaw', ts.citations
				FROM submissions as s
				LEFT JOIN temp_submissions as ts
					ON s.submission_id = ts.submission_id
				WHERE ts.citations IS NOT NULL
		</query>
		<query>
			INSERT INTO publication_settings(publication_id, setting_name, setting_value)
				SELECT s.current_publication_id, 'pages', ts.pages
				FROM submissions as s
				LEFT JOIN temp_submissions as ts
					ON s.submission_id = ts.submission_id
				WHERE ts.pages IS NOT NULL
		</query>
		<query>
			INSERT INTO publication_settings(publication_id, setting_name, setting_value)
				SELECT s.current_publication_id, 'hide_author', ts.hide_author
				FROM submissions as s
				LEFT JOIN temp_submissions as ts
					ON s.submission_id = ts.submission_id
				WHERE ts.hide_author IS NOT NULL
		</query>

		<!-- migrate issue_id, seq from published_submissions to publication settings -->
		<query>
			INSERT INTO publication_settings(publication_id, setting_name, setting_value)
				SELECT s.current_publication_id, 'issueId', ps.issue_id
				FROM temp_published_submissions as ps
				LEFT JOIN submissions as s
					ON ps.submission_id = s.submission_id
				WHERE s.current_publication_id IS NOT NULL
		</query>
		<query>
			INSERT INTO publication_settings(publication_id, setting_name, setting_value)
				SELECT s.current_publication_id, 'seq', ps.seq
				FROM temp_published_submissions as ps
				LEFT JOIN submissions as s
					ON ps.submission_id = s.submission_id
				WHERE s.current_publication_id IS NOT NULL
		</query>

		<!-- move some author data to settings table -->
		<query>
			INSERT INTO author_settings(author_id, setting_name, setting_value)
			SELECT ta.author_id, 'country', ta.country
			FROM temp_authors as ta
		</query>
		<query>
			INSERT INTO author_settings(author_id, setting_name, setting_value)
			SELECT ta.author_id, 'url', ta.url
			FROM temp_authors as ta
			WHERE ta.url IS NOT NULL
		</query>
		<!-- connect authors to publications -->
		<query>
			UPDATE authors as a
			SET a.publication_id = (
				SELECT s.current_publication_id
				FROM submissions as s
				LEFT JOIN temp_authors as ta
					ON s.submission_id = ta.submission_id
				WHERE a.author_id = ta.author_id
			)
		</query>

		<!-- connect categories to publications -->
		<query>
			INSERT INTO publication_categories(publication_id, category_id)
				SELECT s.current_publication_id, tsc.category_id
				FROM temp_submission_categories as tsc
				LEFT JOIN submissions as s
					ON s.submission_id = tsc.submission_id
				WHERE s.current_publication_id IS NOT NULL
		</query>

		<!-- move submission_galleys to publication_galleys -->
		<query>
			INSERT INTO publication_galleys(galley_id, locale, publication_id, label, file_id, seq, remote_url, is_approved)
				SELECT tsg.galley_id, tsg.locale, s.current_publication_id, tsg.label, tsg.file_id, tsg.seq, tsg.remote_url, tsg.is_approved
				FROM submissions as s, temp_submission_galleys as tsg
				WHERE s.submission_id = tsg.submission_id
		</query>
		<query>
			INSERT INTO publication_galley_settings(galley_id, locale, setting_name, setting_value)
				SELECT tsgs.galley_id, tsgs.locale, tsgs.setting_name, tsgs.setting_value
				FROM temp_submission_galley_settings as tsgs
				WHERE tsgs.galley_id IS NOT NULL
		</query>

		<!-- connect controlled vocab metadata to publications, 1048585 = ASSOC_TYPE_SUBMISSION, 1048588 = ASSOC_TYPE_PUBLICATION -->
		<query>
			UPDATE controlled_vocabs AS cv,
			          submissions AS s
			SET cv.assoc_type = 1048588, cv.assoc_id = s.current_publication_id
			WHERE cv.assoc_type = 1048585 AND s.submission_id = cv.assoc_id
		</query>

		<!-- connect citations to publications -->
		<query>
			UPDATE citations as c
			SET c.publication_id = (
				SELECT s.current_publication_id
				FROM submissions as s
				LEFT JOIN temp_citations as tc
					ON s.submission_id = tc.submission_id
				WHERE c.citation_id = tc.citation_id
			)
		</query>

		<!-- remove deprecated and temporary tables. should be last commands -->
		<query>DROP TABLE submission_categories</query>
		<query>DROP TABLE submission_galleys</query>
		<query>DROP TABLE submission_galley_settings</query>
		<query>DROP TABLE published_submissions</query>
		<query>DROP TABLE temp_authors</query>
		<query>DROP TABLE temp_submissions</query>
		<query>DROP TABLE temp_submission_categories</query>
		<query>DROP TABLE temp_submission_galleys</query>
		<query>DROP TABLE temp_submission_galley_settings</query>
		<query>DROP TABLE temp_published_submissions</query>
		<query>DROP TABLE temp_citations</query>
	</sql>
</data>
