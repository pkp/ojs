language: php
php:
  - 5.3
git:
  # We have to init submodules ourselves
  submodules: false

before_install:
  # Start submodules
  - ./tools/startSubmodulesTRAVIS.sh

  # Start apache and configure a virtual host.
  - sudo apt-get update > /dev/null
  - sudo apt-get install -y --force-yes apache2 libapache2-mod-php5 php5-curl php5-mysql php5-intl
  - sudo sed -i -e "s,/var/www,$(pwd)/,g" /etc/apache2/sites-available/default 
  - sudo sed -i -e "s,\${APACHE_LOG_DIR},$(pwd),g" /etc/apache2/sites-available/default  
  - sudo /etc/init.d/apache2 restart

  # Install phpunit in a phar package with selenium extension already on it. 
  - sudo rm -R /home/travis/.phpenv/versions/5.3/bin/phpunit
  - wget --no-check-certificate https://phar.phpunit.de/phpunit.phar
  - chmod +x phpunit.phar
  - sudo mv phpunit.phar /home/travis/.phpenv/versions/5.3/bin/phpunit
 
  # Start Virtual Framebuffer to imitate a monitor.
  - sudo Xvfb :10 -ac > xvfb-output & 
  - export DISPLAY=:10
  - sleep 3 # Give xvfb time to start.

  # Start selenium server.
  - wget http://selenium-release.storage.googleapis.com/2.41/selenium-server-standalone-2.41.0.jar
  - nohup java -jar selenium-server-standalone-2.41.0.jar -browserSessionReuse -debug > selenium-output & 
  - sleep 3 # Give selenium server time to start.

  # Install the test database.
  - mysql -u root -e 'create database ojs'
  - mysql -u root ojs < tests/functional/testserver.sql

  # Files dependency.
  - mv config.TRAVIS.inc.php config.inc.php

  # Make sure permissions are ok.
  - sudo chown -R travis:www-data .

  # Sleep and output our logs, to avoid hanging 
  # build with no access to logs.
  - (sleep 590; cat access.log; cat error.log; cat xvfb-output; cat selenium-output cat ./lib/pkp/tests/results/error.log) &

script:
  - ./lib/pkp/tools/runAllTests.sh -Ccf
  - ./lib/pkp/tools/validatexml.sh

after_script: 
  # Print logs and outputs for debugging.
  - cat access.log
  - cat error.log
  - cat xvfb-output
  - cat selenium-output
  - cat ./lib/pkp/tests/results/error.log
